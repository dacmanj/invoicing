{"ts":1386192645216,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"# == Schema Information\n#\n# Table name: accounts\n#\n#  id                         :integer          not null, primary key\n#  name                       :string(255)\n#  default_account_ar_account :string(255)\n#  contact_id                 :integer\n#  address_id                 :integer\n#  created_at                 :datetime         not null\n#  updated_at                 :datetime         not null\n#  database_id                :string(255)\n#  primary_contact_id         :integer\n#\n\nclass Account < ActiveRecord::Base\n  has_many :email_records\n\thas_many :contacts, dependent: :destroy\n\thas_many :address, :through => :contacts\n\thas_many :invoices\n\thas_many :payments\n\t\n\tattr_accessible :address_id, :primary_contact_id, :contacts, :default_account_ar_account, :name, :contacts_attributes, :address_attributes, :database_id\n  accepts_nested_attributes_for :contacts, allow_destroy: true\n  accepts_nested_attributes_for :address, :reject_if => :all_blank, allow_destroy: true\n  \n\n  \tdef self.valid_ar_accounts\n\t\tvalid_ar_accounts = ['1110'];\n  \t\tvalid_ar_accounts.map {|h| [h, h]} # name, id\n  \tend\n\n  \tdef balance_due\n  \t\towed = 0\n  \t\tself.invoices.each { |i| owed += i.balance_due }\n  \t\towed\n  \tend\n\n  \tdef unpaid_invoices\n  \t\tself.invoices.reject{|x| !x.unpaid? }\n  \tend\n\n    def self.import file, override\n      errors = Array.new\n      CSV.foreach(file.path, headers: true) do |row|\n        account = (find(row[:id]) unless row[\"id\"].blank?) || (find_by_database_id(row[\"database_id\"]) unless row[\"database_id\"].blank?) || new\n        #account.attributes = row.to_hash.slice(*accessible_attributes)\n        account.database_id = row[\"database_id\"]\n        account.name = row[\"company\"]\n\n        account.default_account_ar_account = account.default_account_ar_account || \"1110\"\n        contact = account.contacts.build\n        contact.first_name = row[\"first_name\"]\n        contact.last_name = row[\"last_name\"]\n        contact.title = row[\"title\"]\n        contact.active = true\n        address = Address.new\n        contact.address = address\n        if row[\"address\"].blank?\n          address.address_lines = [row[\"address_line_1\"],row[\"address_line_2\"],row[\"address_line_3\"]].join(\"\\n\")\n        else\n          address.address_lines = row[\"address\"]\n        end\n\n        address.city = row[\"city\"]\n        address.state = row[\"state\"]\n        address.zip = row[\"zip\"]\n        account.save!\n        contact.save!\n        address.save!\n    end\n    errors\n    end\n\nend\n"]],"start1":0,"start2":0,"length1":0,"length2":2469}]],"length":2469}
