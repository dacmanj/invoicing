<div class="page-header">

  <h1>Invoices  <%= link_to content_tag(:i, '', :class => "glyphicon glyphicon-plus-sign"), new_invoice_path  %></h1>
  <h4>Total Outstanding Invoices <%= number_to_currency(Invoice.select{|h| h.balance_due > 0}.map{|h| h.balance_due}.inject{|sum,h| sum+h}) %></h4>

<%= form_tag invoices_path, :method => :get, :class => "form-inline well" do |f| %>
  <div class="form-group">
    <%= text_field_tag :name, "#{params[:name]}",:placeholder => "Name", :id => "invoice-search" %>
  </div>
  <div class="checkbox">
    <label for="outstanding_balance">
      <%= check_box_tag :outstanding_balance, "yes", (@outstanding_balance) %>
      Outstanding Balance?
    </label>
  </div>
  <div class="form-group">
    <%= text_field_tag :balance_due_as_of_date, "#{params[:balance_due_as_of_date]}",:class => "datepicker" %>
  </div>
  <div class="form-group">
      <%= select_tag :ar_account, options_for_select(Account.valid_ar_accounts.insert(0,['','']),:selected => params[:ar_account]), :class => "col-md-4 select optional form-control" %>
  </div>
  <div class="form-group">
    <%= submit_tag "Filter", :class => "btn btn-primary", :label => "Filter" %>
  </div>
<% end %>

<%= form_tag edit_multiple_invoices_path do %>
  <div class="form-inline well">
    <div class="form-group col-md-3">
      <label class="sr-only" for="account_id"> Bulk Email</label>
      <%= select_tag "email_template_id", options_for_select(EmailTemplate.order(:name).collect{ |a| [a.name, a.id] }.insert(0, ["Select Template...",""])), {:class => "select optional form-control"}%> 
    </div>
    
    <div class="checkbox">
      <label for="test_email">
        <%= check_box_tag :test_email, "yes", (params[:test_email] == "yes") %>
        Test Email
      </label>
    </div>

    <%= submit_tag "Send Email", :class => "btn btn-danger" %>

  </div>


  <table class="table table-bordered table-striped" id="invoices-table">
    <tr>
      <th>
        <%= check_box_tag 'select_all_invoice_id', '', false %>
      </th>
      <th>Invoice #<%= link_to content_tag(:b, '', :class => "caret"), invoices_path(:sort => "id", :ar_account => params[:ar_account], :outstanding_balance => params[:outstanding_balance]) %>
      </th>
      <th>A/R Account<%= link_to content_tag(:b, '', :class => "caret"), invoices_path(:sort => "ar", :ar_account => params[:ar_account], :outstanding_balance => params[:outstanding_balance]) %></th>
      <th>Invoice Date<%= link_to content_tag(:b, '', :class => "caret"), invoices_path(:sort => "date", :ar_account => params[:ar_account], :outstanding_balance => params[:outstanding_balance]) %></th>
      <th>Company</th>
      <th>Contact</th>
      <th>Last Email
      <%= link_to content_tag(:b, '', :class => "caret"), invoices_path(:sort => "last_email",:ar_account => params[:ar_account], :outstanding_balance => params[:outstanding_balance]) %>
      </th>
      <th>Total
      <%= link_to content_tag(:b, '', :class => "caret"), invoices_path(:sort => "total",:ar_account => params[:ar_account], :outstanding_balance => params[:outstanding_balance]) %>
      </th>
      <th>Balance Due
      <%= link_to content_tag(:b, '', :class => "caret"), invoices_path(:sort => "balance_due",:ar_account => params[:ar_account], :outstanding_balance => params[:outstanding_balance]) %>

      </th>
      <th style="min-width: 250px;"></th>
    </tr>

  <% @invoices.each do |invoice| %>
    <tr>
      <td><%= check_box_tag 'invoice_id[]', invoice.id, false %></td>
      <td><%= link_to content_tag(:i, invoice.id, :class => "glyphicon glyphicon-pencil"), edit_invoice_path(invoice.id) %>
      </td>
      <td>
        <%= invoice.ar_account %>
      </td>
      <td>
        <%= invoice.date.strftime("%m/%d/%Y") unless invoice.date.blank? %>
      </td>
      <td>
        <% unless invoice.account.blank? %>
          <%= link_to invoice.account.name, edit_account_path(invoice.account) %>
        <% end %>     
      </td>
      <td>
        <% unless invoice.primary_contact.blank? %>
          <%= link_to invoice.primary_contact.name, edit_contact_path(invoice.primary_contact) %>
        <% end %>
      </td>
      <td>
        <%= link_to invoice.email_records.last.created_at.localtime.strftime("%m/%d/%Y"), email_record_path(invoice.email_records.last), :target => "_BLANK" unless invoice.email_records.blank?%>
      </td>

      <td>
        <%= number_to_currency invoice.total %>
      </td>
      <td>
        <%= number_to_currency invoice.balance_due(params[:balance_due_as_of_date]) %>
      </td>
      <td>
        <%= render 'invoices/action_bar', :invoice => invoice %>

      </td>
    </tr>
  <% end %>
  <tr>
  <td>
    <% csv_params_allowed = ["sort","ar_account","outstanding_balance","balance_due_as_of_date", "name", "utf8", "commit", "all"] %>
    <%= link_to "CSV", invoices_path(params.reject{|k,v| !csv_params_allowed.include? k || v.empty? }.merge("format" => "csv")) %>
  </td>
  <td colspan="6">
    Totals  
  </td>
  <td>
    <%= number_to_currency(@invoices.map{|h| h.total}.inject{|sum,h| sum+h}) %>
  </td>
  <td>
    <%= number_to_currency(@invoices.select{|h| h.balance_due(params[:balance_due_as_of_date]) > 0}.map{|h| h.balance_due(params[:balance_due_as_of_date])}.inject{|sum,h| sum+h}) %>
  </td>
  <td>
  </td>
  </tr>
  </table>


<% end %>
